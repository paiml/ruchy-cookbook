name: Quality Gates

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  quality:
    name: PMAT Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Check repository structure
        run: |
          echo "üîç Verifying repository structure..."

          required_dirs=(
            "src"
            "recipes"
            "scripts"
            ".pmat"
            "docs"
          )

          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "‚ùå Missing required directory: $dir"
              exit 1
            fi
            echo "‚úÖ $dir exists"
          done

      - name: Verify PMAT configuration
        run: |
          echo "üîç Checking PMAT configuration..."

          if [ ! -f ".pmat/config.toml" ]; then
            echo "‚ùå Missing .pmat/config.toml"
            exit 1
          fi

          if [ ! -f ".pmat/roadmap.yaml" ]; then
            echo "‚ùå Missing .pmat/roadmap.yaml"
            exit 1
          fi

          echo "‚úÖ PMAT configuration found"

      - name: Check build system
        run: |
          echo "üîç Checking build system..."

          if [ ! -f "Makefile" ]; then
            echo "‚ùå Missing Makefile"
            exit 1
          fi

          if [ ! -f "book.toml" ]; then
            echo "‚ùå Missing book.toml"
            exit 1
          fi

          echo "‚úÖ Build system configured"

      - name: Verify scripts are executable
        run: |
          echo "üîç Checking script permissions..."

          for script in scripts/*.sh; do
            if [ ! -x "$script" ]; then
              echo "‚ùå Script not executable: $script"
              exit 1
            fi
            echo "‚úÖ $script is executable"
          done

      - name: Recipe quality check
        run: |
          echo "üìä Recipe Quality Metrics:"

          total_recipes=$(find recipes/ -name "main.ruchy" | wc -l)

          if [ "$total_recipes" -eq 0 ]; then
            echo "‚ö†Ô∏è  No recipes found yet"
            exit 0
          fi

          echo "Total recipes: $total_recipes"

          # Check each recipe has tests
          for recipe_dir in recipes/ch*/recipe-*/; do
            if [ ! -d "$recipe_dir" ]; then
              continue
            fi

            recipe_name=$(basename "$(dirname "$recipe_dir")")/$(basename "$recipe_dir")

            # Count test files
            test_count=0
            [ -f "$recipe_dir/tests/unit_tests.ruchy" ] && test_count=$((test_count + 1))
            [ -f "$recipe_dir/tests/property_tests.ruchy" ] && test_count=$((test_count + 1))
            [ -f "$recipe_dir/tests/integration_tests.ruchy" ] && test_count=$((test_count + 1))

            if [ "$test_count" -lt 2 ]; then
              echo "‚ö†Ô∏è  $recipe_name has only $test_count test file(s)"
            else
              echo "‚úÖ $recipe_name has $test_count test file(s)"
            fi
          done

      - name: Documentation check
        run: |
          echo "üìö Checking documentation..."

          if [ ! -f "src/SUMMARY.md" ]; then
            echo "‚ùå Missing src/SUMMARY.md"
            exit 1
          fi

          if [ ! -f "src/introduction.md" ]; then
            echo "‚ùå Missing src/introduction.md"
            exit 1
          fi

          echo "‚úÖ Core documentation exists"

      - name: Quality summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "‚úÖ Quality Gates Summary"
          echo "========================================"
          echo "Repository structure: ‚úÖ"
          echo "PMAT configuration: ‚úÖ"
          echo "Build system: ‚úÖ"
          echo "Scripts: ‚úÖ"
          echo "Documentation: ‚úÖ"
          echo ""
          echo "Ready for production deployment!"
